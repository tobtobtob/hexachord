<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>Hexachord</title>
  </head>
  <body style="background-color: steelblue; font-family: arial;">
    <div id="synth" style="display: flex; background-color: paleturquoise;">
      <div id="waveformcontainer" style="padding-left: 20px;">
        <p style="margin: 0px;">Waveform</p>
        <select id="waveform">
          <option value="sine">sine</option>
          <option value="sawtooth">sawtooth</option>
          <option value="square">square</option>
          <option value="triangle">triangle</option>
        </select></div>
      <div id="filtercontainer" style="padding-left: 20px">
        <p style="margin: 0px">Filter freq</p>
        <input type="range" min="1" max="100" value="50" class="slider" id="filter">
      </div>
      <div id="notelenghtcontainer" style="padding-left: 20px;">
        <p style="margin: 0px">Note length</p>
        <input type="range" min="1" max="100" value="50" class="slider" id="notelength">
      </div>
    </div>
    <div id="elm"></div>
    <script src=elm.js></script>
    <script>var app = Elm.Main.init({
      node: document.getElementById('elm'),
    })
    var audioContext  = new AudioContext();
    
    var waveformSelector = document.getElementById('waveform');
    var filterSlider = document.getElementById('filter');
    var noteLengthSlider = document.getElementById('notelength');
    
    function getNoteLength(){
      return 2 * (0.01 * noteLengthSlider.value)
    }
    
    function setFilterFrequency(filter){
      var percentage = filterSlider.value / 100.0;
      var min = 120;
      var filterFreq = Math.pow((audioContext.sampleRate/2.0-min), percentage)+min
      filter.type = "lowpass";
      filter.frequency.value = filterFreq;
    }
    
    function start(frequency) {
      var vco = audioContext.createOscillator();
      vco.type = waveformSelector.value;
      vco.frequency.value = frequency;
    
      var vca = audioContext.createGain();
      vca.gain.value = 0.3;
    
      var filter = audioContext.createBiquadFilter();
      setFilterFrequency(filter);
    
      // create connections
      vco.connect(filter)
      filter.connect(vca)
      vca.connect(audioContext.destination);
    
      vco.start(0);
      var now = audioContext.currentTime;
      var noteLength = getNoteLength();
      vca.gain.linearRampToValueAtTime(0, audioContext.currentTime + noteLength);
      vco.stop(now + noteLength);
    }
    
    app.ports.startRaw.subscribe(function (frequency) {
      start(frequency);
    });</script>
  </body>
</html>